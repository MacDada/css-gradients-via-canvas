<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="robots" content="follow,noindex" /><!-- see: http://weston.ruter.net/projects/css-gradients-via-canvas/ -->
    <title>CSS Gradients via Canvas</title>
	<style>
	p {
		line-height:1.2em;
	}
	</style>
</head>
<body>
    <h1>CSS Gradients via Canvas</h1>
	
	<p><em>(Cross-posted at <a href="http://weston.ruter.net/projects/css-gradients-via-canvas/">http://weston.ruter.net/projects/css-gradients-via-canvas/</a>)</em></p>

	<!-- begin -->
	
	<p>In a current project at <a href="http://shepherd-interactive.com/">Shepherd Interactive</a>, certain page elements were designed with
	background <a href="http://en.wikipedia.org/wiki/Image_gradient" title="Image gradient @ Wikipedia">gradients</a>.
	Given the desire to <a href="http://developer.yahoo.com/performance/rules.html#num_http" title="Minimize HTTP Requests @ Best Practices for Speeding Up Your Web Site">minimize</a>
	the need for externally-loaded background images wherever possible, I thought this would be a great opportunity to play around with WebKit's
	proposed <a href="http://webkit.org/blog/175/introducing-css-gradients/" title="Introducing CSS Gradients">CSS Gradients</a>, which are natively supported
	by Safari, Chrome, and other WebKit-based browsers. In being a WebKit proposal, however, CSS Gradients are not (yet) natively supported in
	other rendering engines as used by Firefox, Opera, and Internet Explorer.</p>
	
	<p><dfn>CSS Gradients via Canvas</dfn> provides a subset of WebKit's CSS Gradients proposal
	for browsers that implement the HTML5 <a href="http://www.whatwg.org/specs/web-apps/current-work/multipage/the-canvas-element.html" title="The canvas element @ HTML5"><code>canvas</code></a> element.
	To use, just include <a href="css-gradients-via-canvas.js">css-gradients-via-canvas.js</a> (12KB) anywhere on the page (see <a href="#examples">examples</a> below).
	Unlike WebKit, this implementation does not currently allow gradients to be used for border images, list bullets, or generated content.
	The script employs <a href="https://developer.mozilla.org/En/DOM/Document.querySelectorAll"><code>document.querySelectorAll()</code></a>—it has no external dependencies
	if this function is implemented; otherwise, it looks for the presence of jQuery, Prototype, or Sizzle to provide selector-querying functionality.</p>
	
	<p id="browser-support">The implementation works in Firefox 2/3+ and Opera 9.64 (at least). Safari and Chrome have native support for CSS Gradients since they use WebKit, as already mentiond.
	This implementation does <em>not</em> work in Internet Explorer since IE does not support Canvas, although IE8 does support the <code>data:</code> URI scheme, which is a prerequisite
	(see <a href="http://weston.ruter.net/2009/05/07/detecting-support-for-data-uris/" title="Detecting Support for data: URIs">support detection method</a>).
	When/if Gears's <a href="http://code.google.com/apis/gears/api_canvas.html">Canvas API</a> fully implements the HTML5 canvas specification, then this implementation
	should be tweakable to work in IE8. In the mean time, rudimentary gradients may be achieved in IE by means of its non-standard
	<a href="http://msdn.microsoft.com/en-us/library/ms532997%28VS.85%29.aspx">gradient filter</a>.</p>
	
	<p>CSS Gradients via Canvas works by parsing all stylesheets upon page load (<code>DOMContentLoaded</code>), and searches for all instances of CSS gradients being
	used as <em>background images</em>. The source code for the external stylesheets is loaded via <code>XMLHttpRequest</code>—ensure that they are
	cached by serving them with a <a href="http://developer.yahoo.com/performance/rules.html#expires">far-future Expires</a> header to avoid extra HTTP traffic.
	The CSS selector associated with the gradient background image property is used to query all elements on the page; for each of the selected elements,
	a canvas is created of the same size as the element's dimensions, and the specified gradients are drawn onto that canvas. Thereafter, the gradient image is
	retrieved via <code>canvas.toDataURL()</code> and this data is supplied as the <code>background-image</code> for the element.</p>
	
	<p id="notes">A few notes regarding interactivity with this implementation: CSS gradients will not be applied to elements dynamically added after <code>DOMContentLoaded</code>.
	Additionally, each element that has a CSS gradient applied to it gets assigned
	a method called <code>refreshCSSGradient()</code>; at any time, this method may be invoked to redraw the gradient on a given element.
	This is especially useful (and necessary) when an element's size dynamically changes, for example as the result of some user interaction. Likewise, it is important
	to note that it will not work to rely on event handlers to invoke <code>refreshCSSGradient()</code> on elements whose style is changed by CSS rules with pseudo-selectors like
	<code>:hover</code> and <code>:active</code>; this is because event handlers are fired before the rule's style changes are applied to the element.
	Toggling an element's class name by scripting is how you can assure that its style will be changed before calling <code>refreshCSSGradient()</code>. The
	<a href="#linear2">last example</a> below demonstrates how this.</p>
	
	<div id="examples">
	<h3>Examples</h3>
	<style scoped="scoped">
	#linear1 { width:150px; height:150px; border:2px solid black; /*padding: 10px; */
		   background:-webkit-gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
		   background:-moz-gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
		   background:-o-gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
		   background:gradient(linear, left top, left bottom, from(#00abeb), to(#fff), color-stop(0.5, #fff), color-stop(0.5, #66cc00));
		   /*-webkit-background-origin: padding-box; -webkit-background-clip: content-box;*/ }
	
	#linear2 {
			border:2px solid black;
			width:150px; height:150px;
			background-image: -webkit-gradient(linear, 0% 25%, 75% 100%,
									 from(red),
									 to(purple),
									 color-stop(.2, orange),
									 color-stop(.4, yellow),
									 color-stop(.6, green),
									 color-stop(.8, blue));
	
	}
	
	#radial1 { width:150px; height:150px; border:2px solid black;
		   background: -webkit-gradient(radial, 45 45, 10, 52 50, 30, from(#A7D30C), to(rgba(1,159,98,0)), color-stop(90%, #019F62)),
					   -webkit-gradient(radial, 105 105, 20, 112 120, 50, from(#ff5f98), to(rgba(255,1,136,0)), color-stop(75%, #ff0188)),
					   -webkit-gradient(radial, 95 15, 15, 102 20, 40, from(#00c9ff), to(rgba(0,201,255,0)), color-stop(80%, #00b5e2)),
					   -webkit-gradient(radial, 0 150, 50, 0 140, 90, from(#f4f201), to(rgba(228, 199,0,0)), color-stop(80%, #e4c700)); }
	
	
	/* Play around with some interactivity; requires manual mouseover/mouseout
	handlers to be attached with Javascript to refresh CSS Gradients when box
	is resized, see script and comments in footer. */
	#linear2 {
		border-color:#CCC;
		border-style:outset;
		cursor:pointer;
		padding:0;
	}
	#linear2:hover {
		border-color:#888;
	}
	html:not(.css-gradients-via-canvas) #linear2:active,
	#linear2.mousedown {
		width:400px;
		border-style:inset;
	}
	
	p:target {
		background-color:#FFFFCC;
		padding:0.2em;
	}
	
	html.no-css-gradients img.fallback,
	html.no-css-gradients #fallback-notice,
	html.no-css-gradients .fallback-notice{
		display:block !important;
		color:red;
	}
	</style>
	
	<p>The following two boxes are from the <a href="http://trac.webkit.org/browser/trunk/LayoutTests//fast/gradients/simple-gradients.html?format=raw">Background
	Gradients Example</a> from WebKit <small>(a couple browser-specific <code>background</code> properties are disabled in the first example)</small>:</p>
	
	<p id='fallback-notice' hidden="hidden" style="display:none"><em>It appears that your browser doesn't support CSS Gradients, neither natively nor via Canvas.
	The gradients you see below are regular externally-loaded PNG images that demonstrate the CSS gradient effects; the gradients were generated from
	this Canvas implementation of CSS Gradients (see <a href="#browser-support">browser support</a> above).</em></p>
	
	<p id="linear1" class='gradient'><img src="linear1.png" class='fallback' style="display:none" title="Fallback image; this is not a CSS Gradient!" /></p>
	<p id="radial1" class='gradient'><img src="radial1.png" class='fallback' style="display:none" title="Fallback image; this is not a CSS Gradient!" /></p>
	
	<p>Here is a bonus diagonal rainbow…but wait, there's more! Clicking on the element causes its width to increase and when it does, its gradient is adjusted (see <a href="#notes">notes</a> above).
	<em hidden="hidden" class='fallback-notice' style="display:none;">(Clicking will not have the desired effect because, again, it appears your browser is not supported.)</em></p>
	
	<p id="linear2" class='gradient'><img src="linear2.png" class='fallback' style="display:none" title="Fallback image; this is not a CSS Gradient!" /></p>
	
	<!-- jQuery, Prototype, and Sizzle looked for in the case that document.querySelectorAll is not available;
	if using another library, please make sure that document.querySelectorAll is implemented -->
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.1/jquery.min.js"></script>
	
	<script src="css-gradients-via-canvas.js"></script>
	<script>
	//Add mousedown/mouseup event handlers to correspond with the :active rule that changes the element's width
	// because the CSS Gradient needs to be refreshed because the box size changes; note that we add the class manually
	// because CSS rules aren't applied before the corresponding events are triggered (thus the box would not
	// be resized when the event handler inspects it).
	
	if(document.addEventListener){
		document.addEventListener('DOMContentLoaded', function(){
			var linear2 = document.getElementById('linear2');
			linear2.addEventListener('mouseup', function(){
				if(this.refreshCSSGradient){
					this.className = this.className.replace(/\s*mousedown/, '');
					this.refreshCSSGradient();
				}
			}, false);
			linear2.addEventListener('mousedown', function(){
				if(this.refreshCSSGradient){
					this.className += " mousedown";
					this.refreshCSSGradient();
				}
			}, false);
		}, false);
	}
	</script>
	</div><!-- end examples -->
	
	<!-- end -->
	
	<hr />
	<footer>
		<address><a href="http://weston.ruter.net/" rel="author">Weston Ruter</a> @ <a href="http://shepherd-interactive.com/">Shepherd Interactive</a></address>
		2009-07-25
	</footer>
</body>
</html>
